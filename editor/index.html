<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spec Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            display: flex;
            height: 100vh;
        }

        #sidebar {
            width: 300px;
            background: #f5f5f5;
            border-right: 1px solid #ddd;
            overflow-y: auto;
            padding: 20px;
        }

        #sidebar h2 {
            margin-bottom: 15px;
            font-size: 18px;
        }

        .spec-item {
            padding: 10px;
            margin-bottom: 5px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .spec-item:hover {
            background: #e3f2fd;
        }

        .spec-item.active {
            background: #2196f3;
            color: white;
        }

        #preview {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fafafa;
            overflow: auto;
        }

        #canvas-container {
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        #error {
            color: red;
            padding: 20px;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Anton&family=Dancing+Script:wght@400;700&family=Great+Vibes&family=Montserrat:wght@100;400;700;900&family=Poppins:wght@100;400;700;900&display=swap" rel="stylesheet">
</head>
<body>
    <div id="sidebar">
        <h2>Design Specs</h2>
        <div id="spec-list"></div>
    </div>
    <div id="preview">
        <div id="error"></div>
        <div id="canvas-container"></div>
    </div>

    <script>
        const SPECS_DIR = '../datasets/canva_specs';
        const RECONSTRUCTIONS_DIR = '../datasets/reconstructions';

        // Google Fonts mapping
        const GOOGLE_FONTS = {
            'Anton': 'Anton',
            'Dancing Script': 'Dancing Script',
            'Great Vibes': 'Great Vibes',
            'Montserrat': 'Montserrat',
            'Poppins': 'Poppins'
        };

        async function loadSpecList() {
            try {
                const response = await fetch(SPECS_DIR);
                const text = await response.text();

                // Parse directory listing (this assumes a simple file server)
                // If you're using a different setup, you might need to provide a manifest
                const parser = new DOMParser();
                const doc = parser.parseFromString(text, 'text/html');
                const links = Array.from(doc.querySelectorAll('a'))
                    .map(a => a.getAttribute('href'))
                    .filter(href => href && href !== '../' && !href.includes('.'));

                const specList = document.getElementById('spec-list');

                for (const dir of links) {
                    const specName = dir.replace('/', '');
                    const item = document.createElement('div');
                    item.className = 'spec-item';
                    item.textContent = specName;
                    item.onclick = () => loadSpec(specName);
                    specList.appendChild(item);
                }
            } catch (error) {
                document.getElementById('error').textContent =
                    'Error loading spec list. Please ensure you\'re running a local server.';
                console.error('Error loading spec list:', error);
            }
        }

        async function loadSpec(specName) {
            try {
                // Update active state
                document.querySelectorAll('.spec-item').forEach(item => {
                    item.classList.toggle('active', item.textContent === specName);
                });

                // Load spec JSON
                const specResponse = await fetch(`${SPECS_DIR}/${specName}/spec.json`);
                const spec = await specResponse.json();

                // Render the spec
                renderSpec(spec, specName);

                document.getElementById('error').textContent = '';
            } catch (error) {
                document.getElementById('error').textContent = `Error loading spec: ${error.message}`;
                console.error('Error loading spec:', error);
            }
        }

        function renderSpec(spec, specName) {
            const canvasWidth = spec.canvas_width || 800;
            const canvasHeight = spec.canvas_height || 600;

            // Build nodes HTML
            let nodesHtml = '';
            let imageNodeIdx = 0;

            for (const node of spec.nodes || []) {
                if (node.type === 'text') {
                    const style = `
                        position: absolute;
                        left: ${node.x}px;
                        top: ${node.y}px;
                        width: ${node.width}px;
                        height: ${node.height}px;
                        transform: rotate(${node.rotation}deg);
                        font-family: ${node['font-family'] || node.font_family};
                        font-size: ${node['font-size'] || node.font_size}px;
                        color: ${node.color};
                        text-align: ${node['text-align'] || node.text_align};
                        font-weight: ${node['font-weight'] || node.font_weight};
                        font-style: ${node['font-style'] || node.font_style};
                        text-decoration: ${node['text-decoration'] || node.text_decoration};
                        text-transform: ${node['text-transform'] || node.text_transform};
                        margin: 0;
                        padding: 0;
                        box-sizing: border-box;
                        display: flex;
                        align-items: center;
                    `;
                    const textContent = escapeHtml(node.text);
                    nodesHtml += `<div style="${style}">${textContent}</div>`;

                } else if (node.type === 'image') {
                    imageNodeIdx++;

                    // Check if asset exists
                    const assetPath = `${RECONSTRUCTIONS_DIR}/${specName}/asset-${imageNodeIdx}.png`;

                    const style = `
                        position: absolute;
                        left: ${node.x}px;
                        top: ${node.y}px;
                        width: ${node.width}px;
                        height: ${node.height}px;
                        transform: rotate(${node.rotation}deg);
                        object-fit: contain;
                    `;

                    // Try to load the asset, fallback to placeholder
                    nodesHtml += `
                        <img
                            src="${assetPath}"
                            style="${style}"
                            alt="${node.asset_description}"
                            onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                        />
                        <div style="${style} background: #ddd; display: none; align-items: center; justify-content: center; font-size: 12px; color: #666; text-align: center; padding: 10px;">
                            [Image: ${node.asset_description?.substring(0, 100) || ''}]
                        </div>
                    `;
                }
            }

            // Build background style
            let bgStyle = `background-color: ${spec.background_color};`;
            if (spec.has_background_image) {
                const bgPath = `${RECONSTRUCTIONS_DIR}/${specName}/background.png`;
                bgStyle = `background-image: url('${bgPath}'); background-size: cover; background-position: center;`;
            }

            // Generate HTML
            const html = `
                <div id="canvas" style="
                    position: relative;
                    width: ${canvasWidth}px;
                    height: ${canvasHeight}px;
                    ${bgStyle}
                    overflow: hidden;
                ">
                    ${nodesHtml}
                </div>
            `;

            document.getElementById('canvas-container').innerHTML = html;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize
        loadSpecList();
    </script>
</body>
</html>
